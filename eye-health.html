<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Udito Zen Custom</title>
<style>
  :root {
    --safe: #3bd67f;
    --moderate: #f1c40f;
    --danger: #e74c3c;
  }
  body {
    margin:0;
    height:100vh;
    display:flex;
    justify-content:center;
    align-items:center;
    background: linear-gradient(135deg,#0f2027,#203a43,#2c5364);
    font-family: 'Segoe UI', sans-serif;
    color: #fff;
  }
  .container{text-align:center;}
  .circle {
    width:180px; height:180px;
    border-radius:50%;
    background: var(--safe);
    display:flex; align-items:center; justify-content:center;
    font-size:2.5em; font-weight:bold;
    box-shadow:0 0 50px rgba(0,0,0,0.3);
    margin:20px auto;
    animation: pulse 2s infinite;
    transition: background 0.5s, transform 0.5s;
  }
  @keyframes pulse {0%,100%{transform:scale(1);}50%{transform:scale(1.05);}}
  .status { font-size:1.2em; opacity:0.8; margin-top:10px; }
  .danger-bar {
    height:15px; width:100%; background:#333;
    border-radius:10px; overflow:hidden; margin-top:20px;
  }
  .danger-fill {
    height:100%; width:0%; background: linear-gradient(90deg,var(--safe),var(--moderate),var(--danger));
    transition: width 0.3s ease;
  }
</style>
</head>
<body>
  <div class="container">
    <h1>health ear</h1>
    <div class="circle" id="circle">-- dB</div>
    <div class="status" id="status">In attesa suoni...</div>
    <div class="danger-bar"><div class="danger-fill" id="dangerFill"></div></div>
  </div>

<script>
async function startCustomMic(){
  try{
    const stream = await navigator.mediaDevices.getUserMedia({audio:true});
    const audioCtx = new (window.AudioContext||window.webkitAudioContext)();
    const analyser = audioCtx.createAnalyser();
    const mic = audioCtx.createMediaStreamSource(stream);
    const processor = audioCtx.createScriptProcessor(512,1,1);

    mic.connect(analyser);
    analyser.connect(processor);
    processor.connect(audioCtx.destination);

    const dataArray = new Uint8Array(analyser.fftSize);
    const circle = document.getElementById("circle");
    const status = document.getElementById("status");
    const dangerFill = document.getElementById("dangerFill");

    const buffer = []; // buffer dei campioni per media

    processor.onaudioprocess = () => {
      analyser.getByteTimeDomainData(dataArray);
      let sum = 0;
      for(let i=0;i<dataArray.length;i++){
        let val = (dataArray[i]-128)/128;
        sum += val*val;
      }
      let rms = Math.sqrt(sum/dataArray.length);
      buffer.push(rms);
      if(buffer.length>20) buffer.shift(); // media degli ultimi 20 frame (~0,5s)

      const avgRms = buffer.reduce((a,b)=>a+b,0)/buffer.length;

      // sistema di misurazione personalizzato: scala 0-120 dB
      let db = Math.min(Math.round(120*avgRms*1.5),120);
      circle.textContent = db + " dB";

      // aggiornamento indicatore
      if(db<60){circle.style.background='var(--safe)'; status.textContent="Ambiente tranquillo 🌱"; dangerFill.style.width=(db/80*100)+"%";}
      else if(db<80){circle.style.background='var(--moderate)'; status.textContent="Rumore moderato ⚠️"; dangerFill.style.width=(db/100*100)+"%";}
      else{circle.style.background='var(--danger)'; status.textContent="Rumore elevato ❗"; dangerFill.style.width="100%";}
    };
  }catch(err){
    document.getElementById("circle").textContent="--";
    document.getElementById("status").textContent="Microfono non disponibile";
  }
}

startCustomMic();
</script>
</body>
</html>
